{% extends 'usuarios/base_gerente.html' %}
{% load static %}

{% block title %}Inventario - Postor Cafe San Pedro de Huaca{% endblock %}

{% block active_inventario %}active{% endblock %}

{% block extra_head %}
<style>
    .btn-confirmar:hover {
        opacity: 0.9;
        transform: scale(1.02);
        transition: 0.2s;
    }

    .edit-btn:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<header>
    <h2>Control de Insumos</h2>
    <div style="display: flex; gap: 10px;">
        <button hx-get="{% url 'inventario:crear_insumo' %}" hx-target="#modal-container" hx-swap="innerHTML"
            class="btn-confirmar"
            style="width: auto; margin: 0; background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
            + Nuevo Insumo
        </button>
        <button hx-get="{% url 'inventario:registrar_movimiento' %}" hx-target="#modal-container" hx-swap="innerHTML"
            class="btn-confirmar"
            style="width: auto; margin: 0; background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
            <i class="fas fa-exchange-alt"></i> Registrar Movimiento
        </button>
    </div>
</header>

<!-- KPI Inventario -->
<div
    style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; align-items: center; gap: 20px; max-width: 400px;">
    <div
        style="background: #e0f2f1; color: #00897b; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
        <i class="fas fa-coins"></i>
    </div>
    <div>
        <h4 style="margin: 0; color: #666; font-size: 0.9rem;">Valor Total Inventario</h4>
        <h2 style="margin: 5px 0 0 0; color: #333;">${{ valor_total_inventario|floatformat:2 }}</h2>
    </div>
</div>

<section class="audit-section">
    <table>
        <thead>
            <tr>
                <th>Insumo</th>
                <th>Unidad</th>
                <th>Tipo</th>
                <th>Costo Promedio</th>
                <th>Stock Actual</th>
                <th>Valor Total</th>
                <th>Estado</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for i in insumos %}
            <tr>
                <td><strong>{{ i.nombre }}</strong></td>
                <td>{{ i.get_unidad_medida_display }}</td>

                <td class="text-center">
                    {% if i.es_subreceta %}
                    <span
                        style="background: #e0e7ff; color: #4318ff; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.75rem;">BATCH/RECETA</span>
                    {% else %}
                    <span style="color: #a0aec0; font-size: 0.8rem;">Insumo</span>
                    {% endif %}
                </td>
                <td>${{ i.costo_unitario|floatformat:2 }}</td>

                {% if i.stock_actual <= i.stock_minimo %} <td
                    style="font-weight: bold; font-size: 1.1em; color: #c62828;">
                    {% else %}
                    <td style="font-weight: bold; font-size: 1.1em; color: #2b3674;">
                        {% endif %}
                        {{ i.stock_actual|floatformat:0 }}
                    </td>
                    <td style="font-weight: bold;">${{ i.valor_total|floatformat:2 }}</td>

                    <td>
                        {% if i.stock_actual <= i.stock_minimo %} <span
                            style="background: #ffebee; color: #c62828; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">
                            ⚠️ BAJO STOCK
                            </span>
                            {% else %}
                            <span
                                style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                                OK
                            </span>
                            {% endif %}
                    </td>
                    <td>
                        <button hx-get="{% url 'inventario:editar_insumo' i.id %}" hx-target="#modal-container"
                            hx-swap="innerHTML" class="edit-btn"
                            style="background: transparent; border: none; color: #f28500; font-weight: bold; cursor: pointer; font-size: 1rem; margin-right: 5px;">
                            <button hx-get="{% url 'inventario:editar_insumo' i.id %}" hx-target="#modal-container"
                                hx-swap="innerHTML" class="edit-btn"
                                style="background: transparent; border: none; color: #f28500; font-weight: bold; cursor: pointer; font-size: 1rem; margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if i.es_subreceta %}
                            <button hx-get="{% url 'pedidos:gestion_receta_insumo' i.id %}" hx-target="#modal-container"
                                hx-swap="innerHTML" class="edit-btn"
                                style="background: transparent; border: none; color: #4318ff; font-weight: bold; cursor: pointer; font-size: 1rem; margin-right: 5px;"
                                title="Gestionar Ingredientes de la Sub-receta">
                                <i class="fas fa-scroll"></i>
                            </button>
                            {% endif %}
                            <button hx-post="{% url 'inventario:eliminar_insumo' i.id %}"
                                hx-confirm="⚠️ ¿Estás seguro de eliminar el insumo '{{ i.nombre }}'?\nSi borras esto, las recetas que lo usen quedarán incompletas."
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                style="background: transparent; border: none; color: #dc2626; font-weight: bold; cursor: pointer; font-size: 1rem;"
                                title="Eliminar Insumo">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                    </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No hay insumos registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endblock %}